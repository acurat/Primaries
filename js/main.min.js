var data,party,lastStateClicked,gopCandidates={},demCandidates={},colors=["#283681","#DAA520","#29AB87","#C60E3B","#D4AA00","#228B22","##FFEBCD","#A52A2A","#FF1493"],huff_post_api_url="http://elections.huffingtonpost.com/pollster/api/charts.json?callback=?",colorMap=function(a,b){d3.selectAll(".state").style("fill","#E0E0E0");for(var c=0;c<b.length;c++)b[c].estimates.length>0&&d3.select("#"+b[c].state).style("fill",fillColor(a,b[c].estimates[0].choice))},fillColor=function(a,b){return"gop"===a?gopCandidates[b]:demCandidates[b]},assignColors=function(a,b){for(var c,d=0,e=0;e<b.length;e++)null!==b[e].estimates&&b[e].estimates.length>0&&null!==b[e].estimates[0].first_name&&(c=b[e].estimates[0].choice,"gop"===a&&void 0===gopCandidates[c]?gopCandidates[c]=colors[d++]:"dem"===a&&void 0===demCandidates[c]&&(demCandidates[c]=colors[d++]))},createLegend=function(a){var b=d3.select("#legend");b.selectAll("*").remove(),b.append("h4").text("Color Legend");var c="gop"==a?gopCandidates:demCandidates;Object.keys(c).forEach(function(a,d){b.append("div").attr("class","legendBox").style("background-color",c[a]).append("p").text(a).attr("class","legendText")})},updateHeader=function(a){var b=d3.select("#header");"gop"===a?b.text("Republican Party presidential primaries, 2016").style("color","#ff0000"):b.text("Democratic Party presidential primaries, 2016").style("color","#0000ff")},updateSummary=function(a){var b=d3.select("#summary");b.selectAll("*").remove(),b.append("h4").text(a.title),a.estimates.length>0?b.append("div").selectAll("p").data(a.estimates).enter().append("p").html(function(a){var b;return b=null===a.first_name?a.choice:a.first_name+" "+a.last_name,"<span class='name'>"+b+"</span><span class='percent'>"+a.value+"%</span>"}):b.append("p").text("The election date for this state is on "+a.election_date)},getTopic=function(a){return"gop"===a?"2016-president-gop-primary":"2016-president-dem-primary"},getData=function(a){$.ajax({url:huff_post_api_url,jsonpCallback:"pollsterCallback",cache:!0,async:!1,dataType:"jsonp",contentType:"application/json",data:{topic:getTopic(a)},success:function(b){data=b,assignColors(a,b),createLegend(a),colorMap(a,b),updateHeader(a),updateSummary(b[0])},error:function(a){console.log(a)}})};d3.selectAll(".state").on("click",function(){var a=d3.select(this).attr("id");if(lastStateClicked!=a){d3.select("#"+lastStateClicked).style("stroke-width",1),d3.select(this).style("stroke-width",3),lastStateClicked=a;for(var b=!1,c=0;c<data.length;c++)if(data[c].state==a){updateSummary(data[c]),b=!0;break}if(!b){var d=d3.select("#summary");d.selectAll("*").remove(),d.append("p").text("Data for primary not available for this state!").style("color","red")}}}),d3.select("#party").on("change",function(){d3.select("#"+lastStateClicked).style("stroke-width",1),getData(this.value)}),getData("dem");